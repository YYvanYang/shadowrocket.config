#==================================================
# Shadowrocket · 稳定/易维护 分流配置
# 国内直连 · 国外代理 · 失败兜底走代理
# last updated: 2025-07-28
#==================================================

[General]
# —— DNS：并行查询 + 回退，减少污染与劫持 ——
dns-server = system, https://1.1.1.1/dns-query, https://dns.google/dns-query
fallback-dns-server = https://cloudflare-dns.com/dns-query
# 直连解析失败时允许走代理重试（非常关键）
dns-direct-fallback-proxy = true

# —— 常见直连网段 / 本地域名 / Portal ——
skip-proxy = 0.0.0.0/8, 10.0.0.0/8, 17.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16, 127.0.0.0/8, localhost, *.local, *.lan, captive.apple.com, *.test
tun-excluded-routes = 0.0.0.0/8, 10.0.0.0/8, 17.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16

# —— UDP 行为：节点不支持 UDP 时直接拒绝，避免 QUIC 走直连 ——
udp-policy-not-supported-behaviour = REJECT

# ——（可选）如果你的节点不支持 UDP/HTTP3，建议开启拦截 QUIC —— 
# AND,((PROTOCOL,UDP),(DEST-PORT,443)),REJECT-NO-DROP

#==================================================
# 规则
#==================================================

[Rule]
# ==== 1) Gmail 发信直连（优先放最前面，避免被其他规则覆盖） ====
# 只针对 SMTP 提交端口，避免把 Web/APP 全部强制直连
AND,((DOMAIN,smtp.gmail.com),(DEST-PORT,465)),DIRECT
AND,((DOMAIN,smtp.gmail.com),(DEST-PORT,587)),DIRECT
# （可选）如果你还需要收取 Gmail 邮件，可按需开启：
# AND,((DOMAIN,imap.gmail.com),(DEST-PORT,993)),DIRECT
# AND,((DOMAIN,pop.gmail.com),(DEST-PORT,995)),DIRECT
# （可选保险）部分脚本/库会用别名
DOMAIN-KEYWORD,gmail-smtp,DIRECT
DOMAIN-KEYWORD,googlemail-smtp,DIRECT

# ==== 2) 常用远程规则集（维护成本低，建议开启自动更新） ====
# 你也可以换成自己更信任的源
# —— 国内直连集合（国内站/常用 CDN 等） ——
RULE-SET,https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Shadowrocket/ChinaMax/ChinaMax.list,DIRECT
# —— Apple 官方服务直连（App Store / iCloud 等） ——
RULE-SET,https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Shadowrocket/Apple/Apple.list,DIRECT

# —— AI 服务强制走代理（Claude、OpenAI、Gemini） ——
# Claude (Anthropic) - 完整域名列表
DOMAIN-SUFFIX,anthropic.com,PROXY
DOMAIN-SUFFIX,claude.ai,PROXY
DOMAIN-SUFFIX,api.anthropic.com,PROXY
DOMAIN-KEYWORD,claude,PROXY
DOMAIN-KEYWORD,anthropic,PROXY

# OpenAI - 完整域名和 CDN 列表
DOMAIN-SUFFIX,openai.com,PROXY
DOMAIN-SUFFIX,chatgpt.com,PROXY
DOMAIN-SUFFIX,chat.com,PROXY
DOMAIN-SUFFIX,sora.com,PROXY
DOMAIN-SUFFIX,platform.openai.com,PROXY
DOMAIN-SUFFIX,api.openai.com,PROXY
DOMAIN-SUFFIX,oaistatic.com,PROXY
DOMAIN-SUFFIX,oaiusercontent.com,PROXY
# OpenAI CDN 和基础设施
DOMAIN-SUFFIX,openaiapi-site.azureedge.net,PROXY
DOMAIN-SUFFIX,openaicom-api-bdcpf8c6d2e9atf6.z01.azurefd.net,PROXY
DOMAIN-SUFFIX,openaicomproductionae4b.blob.core.windows.net,PROXY
DOMAIN-SUFFIX,production-openaicom-storage.azureedge.net,PROXY
DOMAIN-SUFFIX,openai.com.cdn.cloudflare.net,PROXY
DOMAIN-SUFFIX,openaicom.imgix.net,PROXY
DOMAIN-SUFFIX,chatgpt.livekit.cloud,PROXY
DOMAIN-SUFFIX,host.livekit.cloud,PROXY
DOMAIN-SUFFIX,turn.livekit.cloud,PROXY
DOMAIN-KEYWORD,openai,PROXY

# Google Gemini / Bard - 完整域名和 API 列表
DOMAIN-SUFFIX,gemini.google.com,PROXY
DOMAIN-SUFFIX,bard.google.com,PROXY
DOMAIN-SUFFIX,ai.google.dev,PROXY
DOMAIN-SUFFIX,aistudio.google.com,PROXY
DOMAIN-SUFFIX,makersuite.google.com,PROXY
DOMAIN-SUFFIX,generativelanguage.googleapis.com,PROXY
DOMAIN-KEYWORD,aiplatform.googleapis.com,PROXY
DOMAIN-KEYWORD,gemini,PROXY
DOMAIN-KEYWORD,bard,PROXY

# —— 常见需要代理的全球性服务 ——
RULE-SET,https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Shadowrocket/Global/Global.list,PROXY
RULE-SET,https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Shadowrocket/Telegram/Telegram.list,PROXY
RULE-SET,https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Shadowrocket/GitHub/GitHub.list,PROXY
RULE-SET,https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Shadowrocket/Google/Google.list,PROXY
RULE-SET,https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Shadowrocket/OpenAI/OpenAI.list,PROXY

# ==== 3) 局域网/本地优先直连 ====
DOMAIN-SUFFIX,local,DIRECT
IP-CIDR,0.0.0.0/8,DIRECT
IP-CIDR,127.0.0.0/8,DIRECT
IP-CIDR,10.0.0.0/8,DIRECT
IP-CIDR,172.16.0.0/12,DIRECT
IP-CIDR,192.168.0.0/16,DIRECT

# ==== 4) 地理直连：CN -> DIRECT ====
GEOIP,CN,DIRECT

# ==== 5) 兜底：其余全部走代理 ====
FINAL,PROXY

#==================================================
# URL Rewrite（可选）
#==================================================

[URL Rewrite]
# 若上面 AND 语句拦截 QUIC 未生效，可用重写删除 HTTP 响应头 Alt-Svc（关闭 H3 提示）
# ^https?:\/\/[^\/]+\/.*$ header,remove,alt-svc

#==================================================
# Host 映射（按需）
#==================================================

[Host]
# 仅在你明确需要直连某内部服务时使用，例如：
# example.internal = 192.168.1.100